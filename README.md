# Trail - Компилятор для языка Snail

## Описание проекта

Trail - это компилятор для статически типизированного языка программирования Snail, а также виртуальная машина для исполнения Snail-программ. Проект демонстрирует реализацию полного стека компиляции: от парсинга исходного кода до генерации байткода и его исполнения.

## Основные возможности языка Snail

- Статическая типизация с поддержкой типов: i32, usize, string, bool, void
- Функции с параметрами и возвращаемыми значениями
- Условные операторы (if-else)
- Циклы (for, while)
- Массивы с фиксированным размером
- Логические операции с короткой схемой вычисления (&&, ||)

## Архитектура компилятора

Компилятор Trail построен по классической многоуровневой архитектуре:

1. **Парсинг** - использует ANTLR4 для генерации парсера на основе грамматики Snail.g4
2. **Построение AST** - создание абстрактного синтаксического дерева из результатов парсинга
3. **Семантический анализ** - проверка типов и другие статические проверки
4. **Генерация байткода** - каждый узел AST генерирует свой байткод
5. **Исполнение** - виртуальная машина исполняет сгенерированный байткод

## Виртуальная машина SnailVM

SnailVM - это стековая виртуальная машина, исполняющая байткод. Байткод состоит из секций:

- Заголовок (magic number, версия, индекс функции main)
- Пул констант
- Таблица функций
- Глобальные переменные
- Глобальный байткод для инициализации переменных

## Недавние улучшения

- Исправлена работа с пулом локальных переменных и инструкцией STORE_LOCAL
- Улучшено именование и документация таблицы функций
- Добавлена документация о том, что JMP и условные переходы используют смещение в байтах
- Исправлена реализация циклов (JMP наверх)
- Улучшена реализация логических операторов && и || с поддержкой короткого вычисления
- Добавлены новые опкоды DUP и JMP_IF_TRUE
- Улучшена обработка глобальных переменных

## Использование

```
trail [options] <file_to_compile>
    --emit-source         печать форматированного исходного кода из AST
    --debug-bytecode FILE вывод отладочной информации о байткоде (.slime)
    --emit-bytecode FILE  вывод байткода в указанный файл (по умолчанию: <input>.slime)
```

## Подробная документация

Подробное описание байткода и архитектуры виртуальной машины содержится в файле `specification.tex`.
